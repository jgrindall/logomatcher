<html>
	<head>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.11.5/paper-full.min.js"></script>
		<script src="logo.js"></script>
		<script src="sketchy.js"></script>
		<script src="phash.js"></script>
		<script src="rembrandt.js"></script>
		<script src="imagetracer.js"></script>
		<script src="pathdata.js"></script>
		<style>
			canvas{
				border:1px dashed blue;
			}
			textarea{
				resize:none;
			}
			*{
				padding:3px;
				font-size:large;
				margin:6px;
			}
		</style>
	</head>
	<body>
		<button id="draw">Draw</button>
		<button disabled id="check">Check</button>
		<br/>
		<br/>
		<table>
			<tr>
				<td><canvas id="canvas0" width='600' height='600'></canvas></td>
				<td><canvas id="canvas1" width='600' height='600'></canvas></td>
				<td id="output">Output</td>
			</tr>
			<tr>
				<td><textarea rows="6" cols="48" id="text0">rpt 10[fd 200 rt 150]</textarea></td>
				<td><textarea rows="6" cols="48" id="text1">fd 50 setpc red setps 6 rpt 10[fd 200 rt 150]</textarea></td>
				<td>
					<button disabled id="correct">Should be marked correct</button>
					<button disabled id="notcorrect">Not correct</button>
				</td>
			</tr>
		</table>
		
		<table id="data">
		</table>
		
		<script>
		
			var points_correct = [];
			var points_incorrect = [];
			var plane_data = {
				pt:{x:0, y:0, z:0},
				normal:{x:0, y:0, z:0}
			};
			
			
			var LOGO_OPTIONS = {
                read: function(s) {
                    console.log("read", s);
                },
                write: function() {
                    console.log("write", arguments);
                },
                clear: function() {
                    console.log("clr");
                }
            };
			
			var OPTIONS =  {
				"ltres":0.1,   // tweak?
				"qtres":-1,    // negative to never match curves
				"scale":1      // why?
			};
			
			var Turtle = function(id){
				this.canvas = document.getElementById(id);
				this.ctx = this.canvas.getContext("2d");
				this.reset();
			};
			
			Turtle.prototype.reset = function(){
				this.ctx.clearRect(0, 0, 600, 600);
				this.heading = -90;
				this.pos = {
					x:300,
					y:300
				};
				this.ctx.moveTo(this.pos.x, this.pos.y);
				this.color = "green";
				this.width = 3;
				this.ctx.lineWidth = this.width;
				this.ctx.strokeStyle = this.color;
				this.penDown = true;
			};
			
			Turtle.prototype.move = function(a){
				var newPos = {
					x:this.pos.x + a*Math.cos(this.heading*Math.PI/180),
					y:this.pos.y + a*Math.sin(this.heading*Math.PI/180)
				};
				if(this.penDown){
					this.ctx.beginPath();
					this.ctx.moveTo(this.pos.x, this.pos.y);
					this.ctx.lineTo(newPos.x, newPos.y);
					this.ctx.stroke();
				}
				else{
					this.ctx.moveTo(newPos.x, newPos.y);
				}
				this.pos.x = newPos.x;
				this.pos.y = newPos.y;
			};
			
			Turtle.prototype.turn = function(a){
				this.heading += a;
			};
			
			Turtle.prototype.initPenDown = function(){
				this.penDown = true;
			};
			
			Turtle.prototype.initPenUp = function(a){
				this.penDown = false;
			};
			
			Turtle.prototype.initPenWidth = function(w){
				this.width = w;
				this.ctx.lineWidth = this.width;
			};
			
			Turtle.prototype.initPenColor = function(c){
				this.color = c;
				this.ctx.strokeStyle = this.color;
			};
			
			var turtles = [
				new Turtle("canvas0"),
				new Turtle("canvas1")
			];
			var interpreters = [
				new LogoInterpreter(turtles[0], LOGO_OPTIONS),
				new LogoInterpreter(turtles[1], LOGO_OPTIONS)
			];
			
			var drawIndex = function(index, text){
				return new Promise(function(resolve, reject){
					interpreters[index]
					.run(text)
					.catch(function(e) {
						alert("error " + e.message);
						resolve();
					})
					.then(function() {
						resolve();
					});
				});
			};
			
			var reset = function(i){
				turtles[0].reset();
				turtles[1].reset();
			};
			
			var _cleanLogo = function(s){
				var COLORS = ["red", "green", "blue"];
				var REGS = _.map(COLORS, function(c){
					return new RegExp(c);
				});
				_.each(REGS, function(re, i){
					s = s.replace(re, "\"" + COLORS[i]);
				});
				return s;
			};
			
			var draw = function(){
				reset();
				$("button#check").attr("disabled", "disabled");
				var t0 = _cleanLogo($("#text0").val());
				var t1 = _cleanLogo($("#text1").val());
				var p = [
					drawIndex(0, t0),
					drawIndex(1, t1)
				];
				Promise.all(p).then(function(){
					// done
					setTimeout(function(){
						check();
						$("button#check").removeAttr("disabled");
					}, 50);
				});
			};
			
			var _format = function(svgstr){
				var output = [], $el = $(svgstr);
				$.each($el.find("path"), function(){
					var pathString = "";
					_.each(this.getPathData(), function(obj){
						pathString += obj.type + (obj.type === "Z" ? "" : obj.values.join(","));
					});
					output.push({
						"fill":"none",
						"stroke":this.getAttribute("stroke"),
						"path":pathString,
						"stroke-opacity":1,
						"stroke-width":this.getAttribute("stroke-width"),
						"stroke-linecap":"round",
						"stroke-linejoin":"round",
						"transform":[],
						"type":"path"
					});
				});
				return output;
			};
			
			var _getPercent = function(canvas0, canvas1){
				var url0 = canvas0.toDataURL();
				var url1 = canvas1.toDataURL();
				return new Promise(function(resolve, reject){
					new window.Rembrandt({
						imageA: url0,
						imageB: url1,
						maxDelta: 10,    // Maximum color delta (0...255):
						maxOffset: 3,	 // Maximum surrounding pixel offset
						renderComposition: false
					})
					.compare()
					.then(function(result){
						resolve({
							"percent":(result.percentageDifference*100).toFixed(1) + "%"
						});
					});
				});
			};
			
			var _getShapeContext = function(canvas0, canvas1){
				return new Promise(function(resolve, reject){
					var svgstr0 = ImageTracer.imagedataToSVG(ImageTracer.getImgdata(canvas0), OPTIONS);
					var svgstr1 = ImageTracer.imagedataToSVG(ImageTracer.getImgdata(canvas1), OPTIONS);
					var c = Sketchy.shapeContextMatch(JSON.stringify(_format(svgstr0)), JSON.stringify(_format(svgstr1)));
					c = Math.round(c*100) + "%";
					resolve({
						"context":c
					});
				});
			};
			
			var _getPHash = function(canvas0, canvas1){
				var url0 = canvas0.toDataURL();
				var url1 = canvas1.toDataURL();
				return new Promise(function(resolve, reject){
					var img0 = new Image(), img1 = new Image();
					img0.onload = function(){
						img1.onload = function(){
							resolve({
								"hashDistance":distance(pHash(img0), pHash(img1))
							});
						};
						img1.src = url1;
					};
					img0.src = url0;
				});
			};
			
			var _predict = function(p){
				return (_dot(_aMinusB(p, plane_data.pt), plane_data.normal) < 0);
			};
			
			var check = function(){
			var _this = this;
				var p = [
					_getShapeContext(canvas0, canvas1),
					_getPHash(canvas0, canvas1),
					_getPercent(canvas0, canvas1),
				];
				Promise.all(p).then(function(out){
					var s = "";
					s += "\n<br/><br/>";
					s += "contextMatch:\t\t" + out[0].context;
					s += "\n<br/><br/>";
					s += "hashDistance:\t\t" + out[1].hashDistance;
					s += "\n<br/><br/>";
					s += "percent:\t\t" + out[2].percent;
					var clrs = ["blue", "black", "gray", "green", "purple", "brown", "red"];
					_this.point = {
						x:parseFloat(out[0].context),
						y:parseFloat(out[1].hashDistance),
						z:parseFloat(out[2].percent)
					};
					var isCorrect = _predict(_this.point);
					s += "\n<br/><br/>";
					s += "predict:\t\t" + isCorrect;
					$("#output").html(s).css("color", clrs[Math.floor(Math.random()*clrs.length)]);
					$("#correct, #notcorrect").removeAttr("disabled");
				});
			};
			
			var _getMP = function(p, q){
				return {
					x:(p.x + q.x)/2,
					y:(p.y + q.y)/2,
					z:(p.z + q.z)/2
				};
			};
			
			var _aPlusB = function(a, b){
				return {
					x:(b.x + a.x),
					y:(b.y + a.y),
					z:(b.z + a.z)
				};
			};
			
			var _aMinusB = function(a, b){
				return {
					x:(-b.x + a.x),
					y:(-b.y + a.y),
					z:(-b.z + a.z)
				};
			};
			
			var _from = function(p, q){
				return _aMinusB(q, p);
			};
			
			var _normalise = function(p){
				var len = Math.sqrt(p.x*p.x + p.y*p.y + p.z*p.z);
				return {
					x:p.x/len,
					y:p.y/len,
					z:p.z/len
				};
			};
			
			var _dot = function(p, q){
				return p.x*q.x + p.y*q.y + p.z*q.z;
			};
			
			var recalc = function(){
				var pt, normal;
				pt = {
					x:0,
					y:0,
					z:0
				};
				normal = {
					x:0,
					y:0,
					z:0
				};
				var _num = 0;
				if(points_correct.length >= 1 && points_incorrect.length >= 1){
					_.each(points_correct, function(p0){
						_.each(points_incorrect, function(p1){
							var myMP = _getMP(p0, p1);
							var myNormal = _normalise(_from(p0, p1));
							if(_num === 0){
								pt = myMP;
								normal = myNormal;
							}
							else{
								pt = _getMP(pt, myMP);
								normal = _getMP(normal, myNormal);
							}
							console.log(p0, p1, myMP, myNormal, "->", pt, normal);
							_num++;
						});
					});
				}
				plane_data.pt = pt;
				plane_data.normal = normal;
				console.log(pt, normal);
				// i think the plane is (x - pt).normal < 0
			};
			
			var _addToTable = function(p, val){
				$("#data").append("<tr><td>" + JSON.stringify(this.point) + "</td><td>" + val + "</td></tr>");
			};
			
			var isCorrect = function(){
				points_correct.push(this.point);
				recalc();
				$("#correct, #notcorrect").attr("disabled", "disabled");
				_addToTable(this.point, "true");
			};
			
			var isNotCorrect = function(){
				points_incorrect.push(this.point);
				recalc();
				$("#correct, #notcorrect").attr("disabled", "disabled");
				_addToTable(this.point, "false");
			};
			
			document.getElementById("draw").addEventListener("click", _.bind(draw, this));
			document.getElementById("correct").addEventListener("click", _.bind(isCorrect, this));
			document.getElementById("notcorrect").addEventListener("click", _.bind(isNotCorrect, this));
			document.getElementById("check").addEventListener("click", _.bind(check, this));

		</script>
	</body>
</html>

